<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>서명페이지 | 분야별민원 | 영등포본동 주민센터</title>
  <link rel="shortcut icon" th:href="@{/images/favicon.ico}">
  <link rel="stylesheet" th:href="@{/css/reset.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb_complaint_sector.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb_status.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb_signature.css}">
  <script th:src="@{/js/jquery-1.12.4.min.js}"></script>
  <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
  <script th:src="@{/js/prefixfree.min.js}"></script>
  <script>const menuName = '서명페이지';</script>
  <script th:src="@{/js/ydpb.js}"></script>
</head>
<body>
<div id="wrap">
  <!-- header -->
  <header class="header" th:replace="~{/common/header_footer_layout :: header}"></header>
  <!-- //header -->

  <!-- search -->
  <div class="search" th:replace="~{/common/header_footer_layout :: search}"></div>
  <!-- //search -->

  <!-- container -->
  <div class="container">
    <div class="contents_wrap safe_area">
      <!-- side menu -->
      <aside class="side_menu" th:replace="~{/common/sidemenu_layout :: sidemenu}"></aside>
      <!-- //side menu -->

      <!-- main -->
      <main>
        <!-- location -->
        <div class="location">
          <div class="location_title">
            <h2>주민등록정정신고</h2>
          </div>
          <div class="location_path">
            <span class="loc_home"><a th:href="@{/}">홈</a></span>
            <span class="loc_arrow">></span>
            <span class="loc_text"><a th:href="@{/}">민원안내</a></span>
            <span class="loc_arrow">></span>
            <span class="loc_text"><a th:href="@{/}">분야별민원</a></span>
            <span class="loc_arrow">></span>
            <span class="loc_text"><a th:href="@{/}">주민등록정정신고</a></span>
            <span class="loc_arrow">></span>
          </div>
          <div class="location_icon">
            <ul class="loc_fixed_icon">
              <li><button type="button" class="loc_print">프린트</button></li>
              <li class="icon_sns">
                <button type="button" class="loc_sns">SNS</button>
                <div class="sns_list">
                  <a th:href="@{/}" class="loc_sns_icon1">a</a>
                  <a th:href="@{/}" class="loc_sns_icon2">a</a>
                  <a th:href="@{/}" class="loc_sns_icon3">a</a>
                  <a th:href="@{/}" class="loc_sns_icon4">a</a>
                  <a th:href="@{/}" class="loc_sns_icon5">a</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <!-- location -->
        <!-- contents -->
        <div class="contents">
          <h3 class="title">주민등록 변경∙정정 신고서 작성</h3>
          <div class="box icon">
            <div class="box_wrap signature_layout">
              <div class="box_title em_blue">온라인 신고 안내</div>
              <p>지정된 칸을 입력 후 엔터(Enter)를 누르면 다음 칸으로 이동하며, 대상자 인적사항은 자동으로 줄이 추가됩니다.</p>
              <p>하단 서명란에 직접 서명 후 <span class="em_red">[제출하기]</span>를 눌러주세요.</p>
            </div>
          </div>

          <div class="form-container" id="formContainer">
            <img th:src="@{/images/sub/signature01.png}" alt="서식" class="form-img">
            <!-- 체크박스 top -->
            <div class="check-box c_top_1" data-group="top_type"></div>
            <div class="check-box c_top_2" data-group="top_type"></div>
            <div class="check-box c_top_3" data-group="top_type"></div>
            <!-- 신고인 -->
            <input type="text" class="form-field f_name" tabindex="1">
            <input type="text" class="form-field f_jumin" tabindex="2">
            <input type="text" class="form-field f_rel" tabindex="3">
            <input type="text" class="form-field f_tel" tabindex="4">
            <input type="text" class="form-field f_phone" tabindex="5">
            <input type="text" class="form-field f_addr" tabindex="6">
            <!-- 신고사항 -->
            <input type="text" class="form-field f_report_content">
            <input type="text" class="form-field f_prev_master">
            <div class="signature-box sig_prev_master">
              <canvas id="sig-pad-prev"></canvas>
            </div>
            <input type="text" class="form-field f_curr_master">
            <div class="signature-box sig_curr_master">
              <canvas id="sig-pad-curr"></canvas>
            </div>
            <!-- 대상자 인적사항 1~5 -->
            <div id="dynamicRows">
              <div class="target-row" data-row="1">
                <input type="text" class="form-field row-input r_rel" data-col="1">
                <input type="text" class="form-field row-input r_name" data-col="2">
                <input type="text" class="form-field row-input r_jumin" data-col="3">
                <input type="text" class="form-field row-input r_pre" data-col="4">
                <input type="text" class="form-field row-input r_post" data-col="5">
              </div>
            </div>
            <!-- 체크박스 mid -->
            <div class="check-box c_mid_1" data-group="mid_type"></div>
            <div class="check-box c_mid_2" data-group="mid_type"></div>
            <div class="check-box c_mid_3" data-group="mid_type"></div>

            <div class="date-row mid-date">
              <input type="text" class="f_year">
              <input type="text" class="f_month">
              <input type="text" class="f_day">
            </div>
            <input type="text" class="form-field f_reporter_name">
            <div class="signature-box sig_reporter">
              <canvas id="sig-pad-1"></canvas>
            </div>

            <div class="check-box c_btm_1" data-group="btm_type"></div>
            <div class="check-box c_btm_2" data-group="btm_type"></div>
            <div class="check-box c_btm_3" data-group="btm_type"></div>

            <div class="date-row btm-date">
              <input type="text" class="f_year">
              <input type="text" class="f_month">
              <input type="text" class="f_day">
            </div>
            <input type="text" class="form-field f_delegate_name">
            <div class="signature-box sig_delegate">
              <canvas id="sig-pad-2"></canvas>
            </div>
          </div>

          <div class="form_btn_wrap btn-wrap">
            <button type="button" id="clearBtn" class="btn btn_cancel">초기화</button>
            <button type="button" id="submitBtn" class="btn btn_primary">제출하기</button>
          </div>
        </div>

        <div class="charge_info">
          <ul>
            <li><span class="info_name">담당부서</span><span>영등포본동</span></li>
            <li><span class="info_name">담당전화번호</span><span>02-2670-1026</span></li>
          </ul>
        </div>
      </main>
    </div>
  </div>

  <footer class="footer" th:replace="~{/common/header_footer_layout :: footer}"></footer>
</div>

<script>
  $(document).ready(function (){
    // 날짜 자동 입력
    const d = new Date();
    $('.f_year').val(d.getFullYear());
    $('.f_month').val(d.getMonth() + 1);
    $('.f_day').val(d.getDate());

    // 캔버스 설정
    const canvasIds = ['sig-pad-1', 'sig-pad-2', 'sig-pad-prev', 'sig-pad-curr'];
    const ctxs = {};

    canvasIds.forEach(id => {
      const canvas = document.getElementById(id);
      if(!canvas) return;

      const ctx = canvas.getContext('2d');
      ctxs[id] = ctx;
      let drawing = false;

      function resize() {
        canvas.width = $(canvas).parent().width();
        canvas.height = $(canvas).parent().height();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#000";
        ctx.lineCap = "round";
      }
      $(window).on('load resize', resize);

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.originalEvent.touches && e.originalEvent.touches[0].clientX);
        const clientY = e.clientY || (e.originalEvent.touches && e.originalEvent.touches[0].clientY);
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      $(canvas).on('mousedown touchstart', function(e){
        drawing = true;
        ctx.beginPath();
        const pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
        if(e.type==='touchstart') e.preventDefault();
      }).on('mousemove touchmove', function(e){
        if(!drawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        if(e.type==='touchmove') e.preventDefault();
      }).on('mouseup mouseleave touchend', function(){ drawing = false; });
    });

    // 체크박스
    $('.check-box').on('click', function (){
      const group = $(this).data('group');
      $(`.check-box[data-group="${group}"]`).not(this).removeClass('active');
      $(this).toggleClass('active');
    });

    // 엔터 키 제어
    const rowStartTop = 44.2;
    const rowGap = 3.2;

    $(document).on('keydown', '.form-field', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        const $this = $(this);

        if($this.hasClass('row-input')){
          const col = parseInt($this.data('col'));
          const row = parseInt($this.closest('.target-row').data('row'));
          if(col < 5){
            $this.closest('.target-row').find(`[data-col="${col+1}"]`).focus();
          } else {
            if (row < 5) {
              addNewRow(row + 1);
            }
          }
        }
        else if($this.attr('tabindex')){
          const nextIdx = parseInt($this.attr('tabindex')) + 1;
          const $next = $(`.form-field[tabindex="${nextIdx}"]`);
          if($next.length > 0) $next.focus();
          else $('.f_report_content').focus();
        }
        else if($this.hasClass('f_report_content')) {
          $('.f_prev_master').focus();
        }
        else if($this.hasClass('f_prev_master')) {
          $('.f_curr_master').focus();
        }
        else if($this.hasClass('f_curr_master')) {
          $('.target-row[data-row="1"] .r_rel').focus();
        }
      }
    });

    function addNewRow(num) {
      if(num > 7) return;
      const top = rowStartTop + ((num - 1) * rowGap);
      const html = `
                <div class="target-row" data-row="${num}">
                    <input type="text" class="form-field row-input r_rel" data-col="1" style="top:${top}%">
                    <input type="text" class="form-field row-input r_name" data-col="2" style="top:${top}%">
                    <input type="text" class="form-field row-input r_jumin" data-col="3" style="top:${top}%">
                    <input type="text" class="form-field row-input r_pre" data-col="4" style="top:${top}%">
                    <input type="text" class="form-field row-input r_post" data-col="5" style="top:${top}%">
                </div>`;
      $('#dynamicRows').append(html);
      $(`.target-row[data-row="${num}"] .r_rel`).focus();
    }

    // 초기화 버튼
    $('#clearBtn').on('click', function (){
      if(confirm('모든 입력 내용과 서명을 초기화 하시겠습니까?')){
        $('.form-field').val('');
        $('.check-box').removeClass('active');
        canvasIds.forEach(id => {
          const canvas = document.getElementById(id);
          if(canvas) ctxs[id].clearRect(0, 0, canvas.width, canvas.height);
        });
        $('#dynamicRows').html($('.target-row[data-row="1"]'));
      }
    });
  });
</script>
</body>
</html>