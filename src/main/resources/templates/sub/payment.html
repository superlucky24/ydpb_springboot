<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>가족관계증명서 신청 | 영등포본동 주민센터</title>
  <link rel="stylesheet" th:href="@{/css/reset.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb_status.css}">
  <link rel="stylesheet" th:href="@{/css/ydpb_SHAdd.css}">
  <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
  <script th:src="@{/js/ydpb.js}"></script>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<div id="wrap">
  <header class="header" th:replace="~{/common/header_footer_layout :: header}"></header>
  <div class="search" th:replace="~{/common/header_footer_layout :: search}"></div>

  <div class="container">
    <div class="contents_wrap safe_area">
      <aside class="side_menu" th:replace="~{/common/sidemenu_layout :: sidemenu}"></aside>

      <main>
        <div class="location">
          <div class="location_title"><h2>가족관계증명서 신청</h2></div>
          <div class="location_path">
            <span class="loc_home"><a th:href="@{/}">홈</a></span>
            <span class="loc_arrow">></span>
            <span class="loc_text">민원안내</span>
            <span class="loc_arrow">></span>
            <span class="loc_text">가족관계증명서</span>
          </div>
        </div>

        <div class="contents">
          <div class="box icon family">
            <div class="box_wrap">
              <div class="box_title">발급 안내</div>
              <p>본 서비스는 로그인 후 이용 가능하며, 수수료 결제 완료 즉시 발급 프로세스가 진행됩니다.</p>
            </div>
          </div>

          <h3 class="title">온라인 신청 정보 확인</h3>

          <div class="temp_box type1">
            <div class="temp_box_wrap">
              <table class="table_form"> <colgroup>
                <col style="width:25%;">
                <col style="width:75%;">
              </colgroup>
                <tbody>
                <tr>
                  <th>신청인 ID</th>
                  <td><strong th:text="${session.memId}">-</strong></td>
                </tr>
                <tr>
                  <th>신청 서류</th>
                  <td>가족관계증명서 (1부)</td>
                </tr>
                <tr>
                  <th>결제 금액</th>
                  <td><span style="color:#e9463c; font-weight:700; font-size:1.8rem;">1,000원</span></td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="form_btns_wrap" style="justify-content: center;">
            <button type="button" onclick="goPayment()" class="btn btn_write" style="width:280px; height:50px; font-size:1.8rem;">
              결제 및 신청서 제출
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>
  <footer class="footer" th:replace="~{/common/header_footer_layout :: footer}"></footer>
</div>

<script th:inline="javascript">
  // 로그인 체크 알림창 우선 실행
  (function() {
    const memId = [[${session.memId}]];
    if (!memId) {
      alert("로그인이 필요한 서비스입니다. 로그인 페이지로 이동합니다.");
      location.href = "/login";
    }
  })();

  async function goPayment() {
    if (!confirm("가족관계증명서 발급 수수료 1,000원을 결제하시겠습니까?")) return;

    try {
      const response = await PortOne.requestPayment({
        storeId: "store-b4f6c958-2d99-4d7c-bc10-7ce431dab851",
        channelKey: "channel-key-ff34e2fa-6621-4673-be89-daf679a0d7f5",
        paymentId: "DOC_" + new Date().getTime(),
        orderName: "가족관계증명서 발급 수수료",
        totalAmount: 1000, //
        currency: "CURRENCY_KRW",
        payMethod: "EASY_PAY",
        easyPay: { giftCertificateType: "KAKAOPAY" },
        customer: { fullName: [[${session.memId}]] }
      });

      if (response.code != null) return alert("결제 실패: " + response.message);

      // 결제 성공 시 발급 완료 페이지로 이동
      alert("결제가 완료되었습니다! 발급 페이지로 이동합니다.");
      location.href = "/sub/complete";

    } catch (error) {
      alert("결제 오류 발생");
    }
  }
</script>
</body>
</html>