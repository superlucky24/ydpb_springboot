<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비밀번호 변경 | 마이페이지 | 영등포본동 주민센터</title>
    <link rel="shortcut icon" th:href="@{/images/favicon.ico}">
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/ydpb.css}">
    <link rel="stylesheet" th:href="@{/css/ydpb_member.css}">
    <link rel="stylesheet" th:href="@{/css/ydpb_SHAdd.css}">
    <script th:src="@{/js/jquery-1.12.4.min.js}"></script>
    <script th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <script>const menuName = '비밀번호수정';</script>
    <script th:src="@{/js/ydpb.js}"></script>
    <script th:src="@{/js/ydpb_member.js}"></script>
</head>
<body>
<div id="wrap" class="member_wrap">
    <header class="header" th:replace="~{common/header_footer_layout :: header}"></header>

    <div class="search" th:replace="~{common/header_footer_layout :: search}"></div>

    <div class="container">
        <div class="contents_wrap safe_area">
            <aside class="side_menu" th:replace="~{common/sidemenu_layout :: sidemenu}"></aside>

            <main>
                <div class="location">
                    <div class="location_title">
                        <h2>비밀번호 수정</h2>
                    </div>
                    <div class="location_path">
                        <span class="loc_home"><a th:href="@{/}">홈</a></span>
                        <span class="loc_arrow">></span>
                        <span class="loc_text"><a th:href="@{/mypage}">마이페이지</a></span>
                        <span class="loc_arrow">></span>
                        <span class="loc_text">비밀번호 변경</span>
                    </div>
                    <div class="location_icon">
                        <ul class="loc_fixed_icon">
                            <li><button type="button" class="loc_print">프린트</button></li>
                            <li class="icon_sns">
                                <button type="button" class="loc_sns">SNS</button>
                                <div class="sns_list">
                                    <a th:href="@{/}" class="loc_sns_icon1">a</a>
                                    <a th:href="@{/}" class="loc_sns_icon2">a</a>
                                    <a th:href="@{/}" class="loc_sns_icon3">a</a>
                                    <a th:href="@{/}" class="loc_sns_icon4">a</a>
                                    <a th:href="@{/}" class="loc_sns_icon5">a</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="member_contents join_contents">
                    <div class="location_title">
                        <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">새 비밀번호 설정</h2>
                        <p style="margin-bottom: 30px; color: #666;">새롭게 사용할 비밀번호를 입력해 주세요.</p>
                    </div>

                    <form th:action="@{/mypage/updatepassword}" method="post" id="passwordChangeForm">
                        <table class="table_form">
                            <tbody>
                            <tr>
                                <th scope="row">새 비밀번호</th>
                                <td>
                                    <input type="password" name="newPassword" id="memPassword" class="input" required style="width: 100%;">
                                    <p class="strongPassword_message1">※ 8~20자 이내 영문, 숫자, 특수문자를 포함해야 합니다.</p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">새 비밀번호 확인</th>
                                <td>
                                    <input type="password" id="memPasswordRe" class="input" required style="width: 100%;">
                                    <p class="strongPassword_message2">※ 비밀번호를 한 번 더 입력해 주세요.</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <div class="btns" style="margin-top:40px; text-align:center;">
                            <button type="submit" class="btn btn_write">비밀번호 변경 완료</button>
                            <a th:href="@{/mypage}" class="btn btn_cancel">취소</a>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>
    <footer th:replace="~{common/header_footer_layout :: footer}"></footer>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function() {
        const passwordForm = document.getElementById("passwordChangeForm");
        const inputMemPassword = document.querySelector('#memPassword');
        const inputMemPasswordRe = document.querySelector('#memPasswordRe');
        const strongPasswordMessage = document.querySelector('.strongPassword_message1');
        const strongPasswordMessage2 = document.querySelector('.strongPassword_message2');

        let isPwValid = false;
        let isPwMatch = false;

        function strongPassword(str) {
            return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,20}$/.test(str);
        }

        // 새 비밀번호 유효성 및 중복 실시간 검사
        inputMemPassword.addEventListener("keyup", function () {
            const currentVal = inputMemPassword.value;

            if (currentVal.length !== 0) {
                // 1단계: 정규식 유효성 검사
                if (!strongPassword(currentVal)) {
                    strongPasswordMessage.textContent ="※ 비밀번호는 8자리 이상 20자리 이하 영어,특수문자,숫자를 포함해야 합니다.";
                    strongPasswordMessage.classList.add("cautionText");
                    inputMemPassword.classList.add("cautionBorder");
                    isPwValid = false;
                } else {
                    // 2단계: 형식이 맞으면 실시간으로 중복 체크 수행
                    $.ajax({
                        url: '/mypage/checkpasswordduplicate',
                        type: 'POST',
                        data: { newPassword: currentVal },
                        success: function(isDuplicate) {
                            if (isDuplicate) {
                                strongPasswordMessage.textContent = "※ 기존 비밀번호와 동일한 비밀번호는 사용할 수 없습니다.";
                                strongPasswordMessage.classList.add("cautionText");
                                inputMemPassword.classList.add("cautionBorder");
                                isPwValid = false;
                            } else {
                                strongPasswordMessage.textContent ="※ 비밀번호 입력 완료";
                                strongPasswordMessage.classList.remove("cautionText");
                                inputMemPassword.classList.remove("cautionBorder");
                                isPwValid = true;
                            }
                        },
                        error: function() {
                            console.log("중복 체크 서버 통신 실패");
                        }
                    });
                }
            }
        });

        // 비밀번호 확인 검사 (일치 여부 포함)
        inputMemPasswordRe.addEventListener("keyup", function () {
            if (inputMemPasswordRe.value.length !== 0) {
                if (inputMemPassword.value !== inputMemPasswordRe.value) {
                    strongPasswordMessage2.textContent ="※ 비밀번호가 일치하지 않습니다.";
                    strongPasswordMessage2.classList.add("cautionText");
                    inputMemPasswordRe.classList.add("cautionBorder");
                    isPwMatch = false;
                } else {
                    strongPasswordMessage2.textContent ="※ 비밀번호가 일치합니다.";
                    strongPasswordMessage2.classList.remove("cautionText");
                    inputMemPasswordRe.classList.remove("cautionBorder");
                    isPwMatch = true;
                }
            }
        });

        passwordForm.addEventListener("submit", function(e) {
            e.preventDefault();

            if (!isPwValid) {
                const currentMsg = strongPasswordMessage.textContent.replace("※ ", "");
                alert(currentMsg);
                inputMemPassword.focus();
                return false;
            }
            if (!isPwMatch) {
                alert("비밀번호가 서로 일치하지 않습니다.");
                inputMemPasswordRe.focus();
                return false;
            }
            passwordForm.submit();
        });
    });
    /*]]>*/
</script>
</body>
</html>